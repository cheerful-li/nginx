!function(e){function n(o){if(t[o])return t[o].exports;var a=t[o]={exports:{},id:o,loaded:!1};return e[o].call(a.exports,a,a.exports,n),a.loaded=!0,a.exports}var t={};return n.m=e,n.c=t,n.p="",n(0)}([function(e,n,t){"use strict";function o(){var e=$(".imgPreviewContainer");e.html(""),p.forEach(function(n){var t=document.createElement("img");t.src=n,e.append(t)})}function a(){var e=window.getSelection(),n=e.getRangeAt(0);return n.commonAncestorContainer==$(".blogContainer")[0]?n.commonAncestorContainer:n.commonAncestorContainer.parentNode==$(".blogContainer")[0]?n.commonAncestorContainer.parentNode:n.commonAncestorContainer.parentNode.parentNode==$(".blogContainer")[0]&&n.commonAncestorContainer.parentNode}function i(){return a()&&"P"==a().tagName}function r(){if(a()){var e=window.getSelection(),n=e.getRangeAt(0),t=n.commonAncestorContainer;if(3==t.nodeType&&(t=t.parentNode),t!=$(".blogContainer")[0]){var o=n.startOffset,i=n.endOffset,r=t.innerText.slice(0,o),c=t.innerText.slice(i);t.innerText=r,""===r.trim()&&(t.innerHTML="<br/>");var l=$("<p/>")[0];$(l).text(c),""===c.trim()&&(l.innerHTML="<br/>"),$(t).after(l);var d=document.createRange();d.selectNode(l.childNodes[0]),d.collapse(!0),e.removeAllRanges(),e.addRange(d)}else{var u="rand_id"+(new Date).getTime();document.execCommand("insertHTML",!1,'<p id="'+u+'"><br/></p>'),m.focusNode($("#"+u).removeAttr("id")[0])}}}function c(e){var n=$("#upfile");n.on("change",function(){var t=new FormData;t.append("file",n[0].files[0]),$.ajax({url:"/blog/xhr/uploadImg",type:"POST",cache:!1,data:t,processData:!1,contentType:!1}).done(e).fail(function(){console.log("img upload fail")}).always(function(){n.off("change")})}),n[0].click()}function l(e){c(function(n){var t=n.result;if(p.push(t),o(),e){var a=m.getRangeNode();a!=$(".blogContainer")[0]?$(a).replaceWith($('<img src="'+t+'"/>')):document.execCommand("insertImage",!1,t)}})}function d(e,n){n&&n.indexOf("js")!==-1&&(n+=" language-javascript"),n&&n.indexOf("css")!==-1&&(n+=" language-css"),n&&n.indexOf("language")!=-1||(n=n?n+" language-html":"language-html");var t=m.getRangeNode();dialog({title:"插入代码",content:'<textarea autofocus id="codeTextarea" style="width:500px;height:300px;"></textarea>',ok:function(){var e=$("#codeTextarea").val(),o=$("<pre><code></code></pre>").addClass(n)[0],a=$("code",o)[0];$(a).text(e),$(t).replaceWith(o),$(o).after("<p><br/></p>"),m.focusNode($(o).next()[0]),Prism.highlightElement(a,!0,function(){console.log("set code callback")})},okValue:"确定",cancelValue:"取消",cancel:function(){}}).showModal()}function u(e,n){var t=m.getRangeNode(),o=$("<"+e+"/>").addClass(n)[0];o.innerHTML=e+" title here",$(t).replaceWith(o),m.selectNode(o)}function s(e,n,t){var o=m.getRangeNode();if(!t)return console.log("table should set param colom and row");var a=+t.split("*")[0],i=+t.split("*")[1],r=["<table>"];r.push("<thead><tr>");for(var c=0;c<i;c++)r.push("<th><br/></th>");for(r.push("</tr></thead>"),r.push("<tbody>"),c=1;c<a;c++){r.push("<tr>");for(var l=0;l<i;l++)r.push("<td><br/></td>");r.push("</tr>")}r.push("</tbody>"),r.push("</table>");var d=$(r.join("")).addClass(n)[0];$(o).replaceWith(d),m.focusNode($("th,td",d)[0])}function g(){if(i()){var e=m.getRange(),n=e.startOffset,t=e.commonAncestorContainer.parentNode,o=t.innerText.slice(0,n);v.deal(o)}else f()}function f(){var e=m.getRangeNode();if("TD"==e.tagName||"TH"==e.tagName){for(var n,t=$(e).closest("table"),o=$("td,th",t),a=0;a<o.length;a++){var i=o[a];if(i==e){n=o[a+1];break}}n&&m.focusNode(n)}}t(1);var m=t(3),p=[],h="",v={data:{},register:function(e,n){v.data[e]=n||function(){}},deal:function(e){var n=e.match(/@[^\.]*|\.[^@]*/g),t="",o="",a="";n&&n.forEach(function(e){0===e.indexOf("@")?o=e.slice(1):t=e.slice(1)}),a=e.split(/\.|@/)[0],v.data[a]&&v.data[a](a,t,o)}};v.register("img",l.bind(void 0,!0)),v.register("code",d);for(var b=1;b<=6;b++)v.register("h"+b,u);v.register("table",s),$(function(){var e=$(".blogContainer");e.on("focus",function(){""===$(this).html()&&($(this).html("<p><br/></p>"),m.focusNode(this.firstChild))}).on("keydown",function(e){return 13==e.which&&a()?(window.enterPrevented=!0,!1):void(13==e.which&&(window.enterPrevented=!1))}).on("keyup",function(e){13==e.which&&window.enterPrevented&&r()}).on("keydown",function(e){if(9==e.which)return console.log("tab"),g(),!1}),$("#uploadArticleImg").on("click",l),$("#uploadIntroductionImg").on("click",function(){c(function(e){var n=h=e.result,t=document.createElement("img");t.src=n,$(".introductionImgContainer").html("").append(t)})});var n=!!location.search&&location.search.match(/id=(\w*)/)[1];n&&$.get("/blog/xhr/detail/"+n).then(function(e){401==e.code&&(location.href="/blog/");var n=e.blog;if(n&&n._id){window.__blogId=n._id,$("[name=title]").val(n.title),$("[name=introductionContent]").val(n.introductionContent),$(".blogContainer").html(n.content),h=n.introductionImg;var t=document.createElement("img");t.src=n.introductionImg,$(".introductionImgContainer").html("").append(t)}else window.__blogId=""})}),$(".submit").on("click",function(){var e=$("[name=title]").val(),n=$(".blogContainer").html(),t=$("#introductionContent").val().trim()?$("#introductionContent").val().trim():$(".blogContainer")[0].innerText.slice(0,120),o={title:e,content:n,introductionImg:h,introductionContent:t,id:window.__blogId||void 0};e.trim()&&n.trim()&&$.ajax({url:"/blog/xhr/blog",method:window.__blogId?"POST":"PUT",data:JSON.stringify(o),contentType:"application/json;charset=UTF-8"}).done(function(e){location.href="/blog/index.html"}).fail(function(e){console.log(e)})}),$("#op_createLink").on("click",function(){var e=window.getSelection().toString(),n=m.getRange();dialog({title:"插入链接",content:'<input id="linkText" style="width:500px;" placeholder="文本" value="'+e+'"></input></br><input autofocus id="linkSrc" style="width:500px;margin-top:20px;" placeholder="src"></input>',ok:function(){var e=$("#linkText").val(),t=$("#linkSrc").val();if(!e||!t)return!1;var o=window.getSelection();o.removeAllRanges(),o.addRange(n),document.execCommand("insertHTML",!1,'<a href="'+t+'">'+e+"</a>")},okValue:"确定",cancelValue:"取消",cancel:function(){}}).showModal()}),$("#op_backColor").on("click",function(){var e=m.getRange();dialog({title:"设置背景色",content:'<input class="form-control" id="input_backColor" style="width:500px;" placeholder="color" ></input>',ok:function(){var n=$("#input_backColor").val();if(!n)return!1;var t=window.getSelection();t.removeAllRanges(),t.addRange(e),document.execCommand("backColor",!1,n)},okValue:"确定",cancelValue:"取消",cancel:function(){}}).showModal()});var w="",x=0;setInterval(function(){var e=$(".blogContainer").html();$(".blogContainer").text().trim()&&e!=w&&(w=e,x%=10,localStorage.setItem("backup_"+x,e),localStorage.setItem("backupId",x),x++)},1e4)},function(e,n){},,function(e,n){"use strict";var t={focusNode:function(e){var n=document.createRange();n.selectNode(e.childNodes[0]),n.collapse();var t=document.getSelection();t.removeAllRanges(),t.addRange(n)},selectNode:function(e){var n=document.createRange();n.selectNode(e.childNodes[0]);var t=document.getSelection();t.removeAllRanges(),t.addRange(n)},getRange:function(){var e=window.getSelection(),n=e.getRangeAt(0);return n},getRangeNode:function(){var e=t.getRange(),n=e.commonAncestorContainer;return 3==n.nodeType&&(n=n.parentNode),n}};e.exports=t}]);